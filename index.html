<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Pesquisa de Dados da Planilha</title>
    <style>
        /* Estilos CSS b√°sicos para melhor visualiza√ß√£o */
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        input[type="text"] { padding: 8px; margin: 5px 0 10px 0; display: block; width: 95%; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        #resultado { margin-top: 20px; padding: 15px; border: 1px solid #007bff; border-radius: 4px; background-color: #f4f9ff; }
        .erro { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <form onsubmit="event.preventDefault(); buscarDados();"> 
            <h2>üìÇ 1. Carregar Planilha (.xlsx)</h2>
            <input type="file" id="inputExcel" accept=".xlsx">
            <p id="statusArquivo">Aguardando carregamento da planilha...</p>

            <hr>

            <h2>üîç 2. Pesquisar</h2>
            <label for="inputUF">UF (Ex: SP):</label>
            <input type="text" id="inputUF">

            <button type="submit" onclick="buscarDados()">Buscar Dados</button>
        </form>

        <hr>

        <h2>üìù 3. Resultado</h2>
        <div id="resultado">
            Nenhum resultado encontrado.
        </div>
    </div>

<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script>
    // O JavaScript que far√° a m√°gica
    let dadosPlanilha = []; // Vari√°vel global para armazenar todos os dados da planilha
    let ultimoResultadoBusca = []; // Nova vari√°vel para guardar o resultado filtrado

    // --- Etapa 1: Carregar e processar o arquivo ---
    document.getElementById('inputExcel').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('statusArquivo').textContent = 'Carregando...';

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // { range: 5 } instrui a biblioteca a pular as primeiras 5 linhas.
                dadosPlanilha = XLSX.utils.sheet_to_json(worksheet, { range: 5 });

                document.getElementById('statusArquivo').textContent = `‚úÖ Planilha carregada com sucesso! (${dadosPlanilha.length} linhas)`;
                console.log("Dados carregados:", dadosPlanilha);

            } catch (error) {
                document.getElementById('statusArquivo').textContent = '‚ùå Erro ao processar o arquivo. Verifique se √© um .xlsx v√°lido.';
                console.error("Erro ao processar:", error);
                dadosPlanilha = [];
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // --- Etapa 2: Fun√ß√£o de Busca (Com Ordena√ß√£o) ---
    function buscarDados() {
        const uf = document.getElementById('inputUF').value.trim().toUpperCase();
        const resultadoDiv = document.getElementById('resultado');
        // A linha que limpava o campo Cidade foi removida

        if (dadosPlanilha.length === 0) {
            resultadoDiv.innerHTML = '<p class="erro">Por favor, carregue a planilha primeiro.</p>';
            return;
        }

        if (!uf) {
            resultadoDiv.innerHTML = '<p class="erro">Preencha o campo UF para pesquisar.</p>';
            return;
        }

        // 1. FILTRA: Realiza a pesquisa de TODAS as linhas que correspondem √† UF
        let resultadosFiltrados = dadosPlanilha.filter(linha => {
            const colunaUF = String(linha.UF || '').toUpperCase();
            return colunaUF === uf;
        });
        
        // 2. ORDENA: Ordena os resultados pelo nome da CIDADE em ordem alfab√©tica.
        // O m√©todo localeCompare √© ideal para strings com caracteres especiais (como acentua√ß√£o).
        ultimoResultadoBusca = resultadosFiltrados.sort((a, b) => {
            const cidadeA = String(a.CIDADE || '').toLowerCase();
            const cidadeB = String(b.CIDADE || '').toLowerCase();
            return cidadeA.localeCompare(cidadeB, 'pt-BR');
        });


        // --- Etapa 3: Exibir a Lista de Resultados ---
        if (ultimoResultadoBusca.length > 0) {
            let htmlResultado = `<h3>üìç ${ultimoResultadoBusca.length} Local(is) Encontrado(s) para ${uf}:</h3>`;
            htmlResultado += '<ul style="list-style-type: none; padding: 0;">';

            ultimoResultadoBusca.forEach((linha, index) => {
                // Acessa as colunas CIDADE, BAIRRO e SIGLA SK (em mai√∫sculo)
                const cidade = linha.CIDADE || 'N/A';
                const bairro = linha.BAIRRO || 'N/A'; 
                const siglaSK = linha['SIGLA SK'] || 'N/A'; 
                
                htmlResultado += `
                    <li style="margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                        <span>
                            <strong>Cidade:</strong> ${cidade}<br>
			    <strong>Bairro:</strong> ${bairro}<br>
                            <strong>Sigla SK:</strong> ${siglaSK}
                        </span>
                        <button onclick="mostrarDetalhes(${index})" style="background-color: #28a745; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;">
                            Ver Detalhes
                        </button>
                    </li>
                `;
            });
            htmlResultado += '</ul>';
            resultadoDiv.innerHTML = htmlResultado;
        } else {
            resultadoDiv.innerHTML = `<p class="erro">Nenhum dado encontrado para UF: ${uf}.</p>`;
        }
    }

    // --- Etapa 4: Fun√ß√£o para Mostrar Detalhes Completos ---
    function mostrarDetalhes(index) {
        const resultadoDiv = document.getElementById('resultado');
        
        // Pega o item completo do array salvo (que agora est√° ordenado)
        const resultadoBusca = ultimoResultadoBusca[index];

        if (!resultadoBusca) {
            resultadoDiv.innerHTML = '<p class="erro">Erro ao carregar os detalhes.</p>';
            return;
        }
        
        // Define as colunas que voc√™ quer exibir nos detalhes
        const colunasSolicitadas = [
            'SIGLA SK', 
            'ENDERE√áO', 
            'BAIRRO', 
            'CEP', 
            'E-MAIL DA UNIDADE', 
            'TELEFONE DA UNIDADE', 
            'WHATSAPP UNIDADE', 
            'HOR√ÅRIO DE ATENDIMENTO AO CLIENTE'
        ];

        let htmlDetalhes = `<h3>üìã Detalhes de ${resultadoBusca.CIDADE} (${resultadoBusca['SIGLA SK']}):</h3>`;
        htmlDetalhes += `<p><strong>UF:</strong> ${resultadoBusca.UF}</p>`;
        htmlDetalhes += `<p><strong>Cidade:</strong> ${resultadoBusca.CIDADE}</p>`; 
        htmlDetalhes += '<hr>';

        // Itera e exibe apenas as colunas solicitadas
        colunasSolicitadas.forEach(chave => {
            const valor = resultadoBusca[chave] || 'N/A'; 
            htmlDetalhes += `<p><strong>${chave}:</strong> ${valor}</p>`;
        });
        
        // Bot√£o para voltar
        htmlDetalhes += '<button onclick="buscarDados()" style="background-color: #6c757d; color: white; padding: 10px 15px; border: none; cursor: pointer; border-radius: 4px; margin-top: 20px;">'
        htmlDetalhes += '‚Üê Voltar para a Lista'
        htmlDetalhes += '</button>';

        resultadoDiv.innerHTML = htmlDetalhes;
    }
</script>
</body>
</html>
